#!/bin/bash

# SMOG-CHECK for SMOG 3

# Unset potential conflict variables
unset SMOG_FFDIR

echo "Collecting information and cleaning up directory before launching smog-check3"

# Define executables
export smog_exec=$(pwd)/bin/smog3
export smog_exec_legacy=$(which smog2)

if [ -z "$smog_exec" ]; then
    echo "COULD NOT FIND SMOG 3 EXECUTABLE! QUITTING"
    # exit 1
fi

echo "Using smog3 at: $smog_exec"

# Since we are running from repo root:
export SMOG_PATH=$(pwd)
export perl4smog="perl"

# Setup environment similar to smog-check
CURDIR=$(pwd)/SMOG-CHECK/src

if [ ! -w "$CURDIR" ]; then
    echo "Current directory is not writable. Quitting smog-check3"
    # exit 1
fi

export PERLLIB=$PERLLIB:$CURDIR/modules
export PERL5LIB=$PERL5LIB:$CURDIR/modules

echo "Will use the scripts found in $SMOG_PATH"

# Setup Template Paths (pointing to repo templates)
export BIFSIF_AA_DEFAULT=$SMOG_PATH/share/templates/SBM_AA
export BIFSIF_CA_DEFAULT=$SMOG_PATH/share/templates/SBM_calpha
export BIFSIF_AA_TESTING=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_AA
export BIFSIF_CA_TESTING=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_calpha
export BIFSIF_STATIC_TESTING=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_AA_STATIC
export BIFSIF_AA_MATCH=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_match
export BIFSIF_AA_2CG=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_2cg
export BIFSIF_AA_CR2=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_cr2
export BIFSIF_AA_BOND=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_AA_BOND
export BIFSIF_AA_DIHE=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_AA_DIHE
export BIFSIF_AA_DIHE4=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_AA_DIHE4
export BIFSIF_AA_CC1=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_AA+customContacts
export BIFSIF_AA_CCD=$SMOG_PATH/SMOG-CHECK/share/templates/SBM_AA+customContacts+customDihedrals

export TOLERANCE=0.001
export PRECISION=10000

# Cleanup
# We need to run cleanup from SMOG-CHECK dir or adapt path
cd SMOG-CHECK
src/cleanup.bash
mkdir -p FAILED

echo "preparation steps completed. Will now launch smog-check3"
echo

# Go back to root
cd $SMOG_PATH

echo "share/settings/smog2.testlist" | perl -I SMOG-CHECK/src/modules SMOG-CHECK/src/check.v2.pl "$@"
